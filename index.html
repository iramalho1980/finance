<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #434343 50%, #c0c0c0 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4a90e2;
            text-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
             .card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-radius: 25px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.3s ease-in-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }       .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 1rem;
            transition: border-color 0.3s ease-in-out;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus {
            border-color: #4a90e2;
            outline: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
        }

        .button.primary {
            background-color: #4a90e2;
            color: #ffffff;
        }

        .button.primary:hover {
            background-color: #357ABD;
            transform: translateY(-2px);
        }

        .button.secondary {
            background-color: #6c757d;
            color: #ffffff;
        }

        .button.secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }

        .table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
            white-space: nowrap;
        }

        .data-table th {
            background-color: rgba(74, 144, 226, 0.3);
            font-weight: 700;
            color: #ffffff;
        }

        .data-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .data-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .total-card {
            grid-column: span 2;
            text-align: center;
            padding: 20px;
            background: rgba(74, 144, 226, 0.2);
            border-radius: 20px;
            border: 1px solid rgba(74, 144, 226, 0.5);
            margin-top: 20px;
        }

        .total-card h2 {
            color: #ffffff;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .total-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: #a7d9ff;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .export-buttons .button {
            background-color: #28a745;
        }

        .export-buttons .button:hover {
            background-color: #218838;
        }

        .search-group {
            margin-bottom: 20px;
        }

        .search-group input {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 1rem;
        }

        .sortable-handle {
            cursor: grab;
            margin-right: 10px;
        }

        .data-table td .action-buttons {
            display: flex;
            gap: 5px;
        }

        .data-table td .action-buttons .button {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .data-table td .action-buttons .button.edit {
            background-color: #ffc107;
            color: #333;
        }

        .data-table td .action-buttons .button.edit:hover {
            background-color: #e0a800;
        }

        .data-table td .action-buttons .button.delete {
            background-color: #dc3545;
            color: #fff;
        }

        .data-table td .action-buttons .button.delete:hover {
            background-color: #c82333;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .total-card {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Controle Financeiro Pessoal</h1>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>Adicionar Transação</h2>
                <div class="form-group">
                    <label for="descricao">Descrição:</label>
                    <input type="text" id="descricao" placeholder="Ex: Salário, Aluguel, Compras" required>
                </div>
                <div class="form-group">
                    <label for="valor">Valor:</label>
                    <input type="number" id="valor" placeholder="Ex: 1500.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo:</label>
                    <select id="tipo">
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="data">Data:</label>
                    <input type="date" id="data" required>
                </div>
                <div class="button-group">
                    <button class="button primary" id="adicionarTransacao">Adicionar Transação</button>
                    <button class="button secondary" id="limparFormulario">Limpar</button>
                    <button class="button primary" id="salvarGitHub">Salvar</button>
                </div>
            </div>

            <div class="card">
                <h2>Resumo Financeiro</h2>
                <div class="chart-container">
                    <canvas id="resumoChart"></canvas>
                </div>
                <div class="total-card">
                    <h2>Saldo Total</h2>
                    <p id="saldoTotal">R$ 0.00</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Extrato de Transações</h2>
            <div class="search-group">
                <input type="text" id="filtroDescricao" placeholder="Filtrar por descrição...">
            </div>
            <div class="table-container">
                <table class="data-table" id="tabelaTransacoes">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Transações serão adicionadas aqui -->
                    </tbody>
                </table>
            </div>
            <div class="export-buttons">
                <button class="button primary" id="exportarPdf">Exportar para PDF</button>
                <button class="button primary" id="exportarCsv">Exportar para CSV</button>
            </div>
        </div>
    </div>

    <script>
        const descricaoInput = document.getElementById('descricao');
        const valorInput = document.getElementById('valor');
        const tipoInput = document.getElementById('tipo');
        const dataInput = document.getElementById('data');
        const adicionarTransacaoBtn = document.getElementById('adicionarTransacao');
        const limparFormularioBtn = document.getElementById('limparFormulario');
        const salvarGitHubBtn = document.getElementById('salvarGitHub');
        const saldoTotalElement = document.getElementById('saldoTotal');
        const tabelaTransacoesBody = document.querySelector('#tabelaTransacoes tbody');
        const filtroDescricaoInput = document.getElementById('filtroDescricao');
        const exportarPdfBtn = document.getElementById('exportarPdf');
        const exportarCsvBtn = document.getElementById('exportarCsv');

        // Configurações do GitHub
        const GITHUB_TOKEN = prompt('Digite seu token de acesso pessoal do GitHub:') || '';
        const GITHUB_OWNER = 'iramalho1980';
        const GITHUB_REPO = 'finance';
        const GITHUB_FILE_PATH = 'bd.json';

        let transacoes = [];
        let resumoChart;

        // Função para carregar transações do GitHub
        async function carregarTransacoes() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content);
                    transacoes = JSON.parse(content);
                    renderizarTransacoes();
                    atualizarResumoFinanceiro();
                } else if (response.status === 404) {
                    // Arquivo não existe ainda, criar vazio
                    transacoes = [];
                    await salvarTransacoesGitHub();
                } else {
                    console.error('Erro ao carregar dados do GitHub:', response.statusText);
                    // Fallback para localStorage
                    const transacoesSalvas = localStorage.getItem('transacoes');
                    if (transacoesSalvas) {
                        transacoes = JSON.parse(transacoesSalvas);
                        renderizarTransacoes();
                        atualizarResumoFinanceiro();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados do GitHub:', error);
                // Fallback para localStorage
                const transacoesSalvas = localStorage.getItem('transacoes');
                if (transacoesSalvas) {
                    transacoes = JSON.parse(transacoesSalvas);
                    renderizarTransacoes();
                    atualizarResumoFinanceiro();
                }
            }
        }

        // Função para salvar transações no localStorage
        function salvarTransacoes() {
            localStorage.setItem('transacoes', JSON.stringify(transacoes));
        }

        // Função para salvar transações no GitHub
        async function salvarTransacoesGitHub() {
            try {
                // Primeiro, obter o SHA do arquivo atual (se existir)
                let sha = null;
                try {
                    const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const getData = await getResponse.json();
                        sha = getData.sha;
                    }
                } catch (error) {
                    console.log('Arquivo não existe ainda, será criado');
                }

                // Preparar o conteúdo
                const content = btoa(JSON.stringify(transacoes, null, 2));
                
                // Salvar no GitHub
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Atualizar dados financeiros',
                        content: content,
                        sha: sha
                    })
                });

                if (response.ok) {
                    alert('Dados salvos no GitHub com sucesso!');
                    // Também salvar localmente como backup
                    salvarTransacoes();
                } else {
                    const errorData = await response.json();
                    console.error('Erro ao salvar no GitHub:', errorData);
                    alert('Erro ao salvar no GitHub. Dados salvos localmente como backup.');
                    salvarTransacoes();
                }
            } catch (error) {
                console.error('Erro ao salvar no GitHub:', error);
                alert('Erro ao salvar no GitHub. Dados salvos localmente como backup.');
                salvarTransacoes();
            }
        }

        // Função para adicionar transação
        adicionarTransacaoBtn.addEventListener('click', () => {
            const descricao = descricaoInput.value.trim();
            const valor = parseFloat(valorInput.value);
            const tipo = tipoInput.value;
            const data = dataInput.value;

            if (descricao && !isNaN(valor) && data) {
                const novaTransacao = { descricao, valor, tipo, data };
                transacoes.push(novaTransacao);
                salvarTransacoes();
                renderizarTransacoes();
                atualizarResumoFinanceiro();
                limparFormulario();
            } else {
                alert('Por favor, preencha todos os campos corretamente.');
            }
        });

        // Função para limpar formulário
        limparFormularioBtn.addEventListener('click', limparFormulario);

        // Função para salvar no GitHub
        salvarGitHubBtn.addEventListener('click', salvarTransacoesGitHub);

        function limparFormulario() {
            descricaoInput.value = '';
            valorInput.value = '';
            tipoInput.value = 'receita';
            dataInput.value = '';
        }

        // Função para renderizar transações na tabela
        function renderizarTransacoes() {
            tabelaTransacoesBody.innerHTML = '';
            const filtro = filtroDescricaoInput.value.toLowerCase();

            const transacoesFiltradas = transacoes.filter(transacao =>
                transacao.descricao.toLowerCase().includes(filtro)
            );

            transacoesFiltradas.forEach((transacao, index) => {
                const row = tabelaTransacoesBody.insertRow();
                row.setAttribute('data-id', index); // Adiciona um ID para facilitar a ordenação

                const handleCell = row.insertCell(0);
                handleCell.innerHTML = '<i class="fas fa-grip-vertical sortable-handle"></i>';

                const descricaoCell = row.insertCell(1);
                descricaoCell.textContent = transacao.descricao;

                const valorCell = row.insertCell(2);
                valorCell.textContent = `R$ ${transacao.valor.toFixed(2)}`;
                valorCell.style.color = transacao.tipo === 'receita' ? '#28a745' : '#dc3545';

                const tipoCell = row.insertCell(3);
                tipoCell.textContent = transacao.tipo === 'receita' ? 'Receita' : 'Despesa';

                const dataCell = row.insertCell(4);
                dataCell.textContent = transacao.data;

                const acoesCell = row.insertCell(5);
                acoesCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="button edit" data-index="${index}">Editar</button>
                        <button class="button delete" data-index="${index}">Excluir</button>
                    </div>
                `;
            });

            // Inicializa o SortableJS
            new Sortable(tabelaTransacoesBody, {
                handle: '.sortable-handle',
                animation: 150,
                onEnd: function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    const [removed] = transacoes.splice(oldIndex, 1);
                    transacoes.splice(newIndex, 0, removed);
                    salvarTransacoes();
                    renderizarTransacoes(); // Renderiza novamente para atualizar os data-id
                },
            });

            // Adiciona event listeners para os botões de editar e excluir
            document.querySelectorAll('.button.edit').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    editarTransacao(index);
                });
            });

            document.querySelectorAll('.button.delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    excluirTransacao(index);
                });
            });
        }

        // Função para editar transação
        function editarTransacao(index) {
            const transacao = transacoes[index];
            descricaoInput.value = transacao.descricao;
            valorInput.value = transacao.valor;
            tipoInput.value = transacao.tipo;
            dataInput.value = transacao.data;

            // Remove a transação da lista para ser adicionada novamente com as edições
            transacoes.splice(index, 1);
            salvarTransacoes();
            renderizarTransacoes();
            atualizarResumoFinanceiro();
        }

        // Função para excluir transação
        function excluirTransacao(index) {
            if (confirm('Tem certeza que deseja excluir esta transação?')) {
                transacoes.splice(index, 1);
                salvarTransacoes();
                renderizarTransacoes();
                atualizarResumoFinanceiro();
            }
        }

        // Função para atualizar resumo financeiro e gráfico
        function atualizarResumoFinanceiro() {
            const totalReceitas = transacoes
                .filter(t => t.tipo === 'receita')
                .reduce((sum, t) => sum + t.valor, 0);

            const totalDespesas = transacoes
                .filter(t => t.tipo === 'despesa')
                .reduce((sum, t) => sum + t.valor, 0);

            const saldoTotal = totalReceitas - totalDespesas;
            saldoTotalElement.textContent = `R$ ${saldoTotal.toFixed(2)}`;
            saldoTotalElement.style.color = saldoTotal >= 0 ? '#28a745' : '#dc3545';

            // Atualizar gráfico
            if (resumoChart) {
                resumoChart.destroy();
            }

            const ctx = document.getElementById('resumoChart').getContext('2d');
                resumoChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Receitas', 'Despesas'],
                        datasets: [{
                            data: [totalReceitas, totalDespesas],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 2,
                            spacing: 5 // Espaçamento entre as fatias
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Tamanho do buraco do donut
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: '#ffffff'
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });sPDF();

            doc.autoTable({
                head: [['Descrição', 'Valor', 'Tipo', 'Data']],
                body: transacoes.map(t => [t.descricao, `R$ ${t.valor.toFixed(2)}`, t.tipo === 'receita' ? 'Receita' : 'Despesa', t.data]),
                startY: 20,
                styles: { fillColor: [74, 144, 226] },
                headStyles: { fillColor: [74, 144, 226] },
                margin: { top: 10 },
            });

            doc.save('extrato_financeiro.pdf');
        });

        // Exportar para CSV
        exportarCsvBtn.addEventListener('click', () => {
            let csvContent = "Descrição,Valor,Tipo,Data\n";
            transacoes.forEach(t => {
                csvContent += `${t.descricao},${t.valor.toFixed(2)},${t.tipo === 'receita' ? 'Receita' : 'Despesa'},${t.data}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'extrato_financeiro.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Carregar transações ao iniciar
        carregarTransacoes();
    </script>
</body>
</html>

